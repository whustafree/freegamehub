);
  try {
    const res = await fetch('/api/free-games');
    if (!res.ok) throw new Error('Error de conexi√≥n');

    const { games, lastUpdated } = await res.json();
    allGamesData = games; // Guardar referencia para filtrar

    // Actualizar fecha
    if (lastUpdated) {
      document.getElementById('last-update').textContent =
      new Date(lastUpdated).toLocaleString('es-CL', {
        timeZone: 'America/Santiago',
        dateStyle: 'medium',
        timeStyle: 'short'
      });
    }

    renderGames('all'); // Mostrar todos al inicio

  } catch (err) {
    console.error(err);
    container.innerHTML = '<p style="text-align:center;width:100%;">‚ùå No se pudo conectar con el servidor local.</p>';
  }
}

function renderGames(filter) {
  const container = document.getElementById('games-container');
  container.innerHTML = '';

  const gamesToShow = filter === 'all'
  ? allGamesData
  : allGamesData.filter(g => g.platform.toLowerCase() === filter);

  if (gamesToShow.length === 0) {
    container.innerHTML = '<p style="text-align:center;grid-column:1/-1;color:#94a3b8;">No se encontraron juegos para esta categor√≠a.</p>';
    return;
  }

  gamesToShow.forEach(game => {
    const endDate = game.endDate
    ? new Date(game.endDate).toLocaleDateString('es-CL', { day: 'numeric', month: 'short' })
    : 'Siempre Gratis';

    const card = document.createElement('div');
    card.className = 'game-card';
    card.innerHTML = `
    <img src="${game.image}" alt="${game.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x150?text=No+Image'">
    <div class="game-info">
    <h3>${game.title}</h3>
    <p>${game.description}</p>
    <div class="meta-info">
    <span class="platform-tag ${game.platform}">${game.platform}</span>
    <span style="font-size:0.8rem; color:#64748b;">üìÖ ${endDate}</span>
    <a href="${game.url}" target="_blank" class="claim-btn">RECLAMAR ‚ûú</a>
    </div>
    </div>
    `;
    container.appendChild(card);
  });
}

// Event Listeners para filtros
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    // Remover clase active de todos
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    // Activar el clickeado
    e.target.classList.add('active');
    // Filtrar
    renderGames(e.target.dataset.filter);
  });
});

document.addEventListener('DOMContentLoaded', loadFreeGames);
